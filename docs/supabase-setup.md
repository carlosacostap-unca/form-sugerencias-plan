# Supabase: Base de datos y configuración

Este documento deja listo el entorno de Supabase para el formulario. Incluye el script SQL para crear todas las tablas, políticas RLS y pasos de configuración.

## Variables de entorno

Agrega las siguientes variables en `.env.local` del proyecto:

```
NEXT_PUBLIC_SUPABASE_URL=<tu-url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<tu-anon-key>
SUPABASE_URL=<tu-url>
SUPABASE_SERVICE_ROLE_KEY=<tu-service-role-key>
```

- `NEXT_PUBLIC_*` son usadas por el cliente (cuando haga falta).
- `SERVICE_ROLE_KEY` se usa solo en las rutas del servidor y bypass RLS.

## Script SQL (ejecutar en el editor SQL de Supabase)

Copiar y ejecutar todo este bloque:

```sql
-- Esquema base
create table if not exists public.docentes (
  id bigint generated by default as identity primary key,
  nombre text not null,
  apellido text not null,
  created_at timestamptz not null default now()
);

create table if not exists public.asignaturas (
  id bigint generated by default as identity primary key,
  nombre text unique not null,
  created_at timestamptz not null default now()
);

-- Campos adicionales para cada asignatura
alter table public.asignaturas add column if not exists anio text;
alter table public.asignaturas add column if not exists regimen text;
alter table public.asignaturas add column if not exists horas_semanales text;
alter table public.asignaturas add column if not exists horas_totales text;
alter table public.asignaturas add column if not exists objetivos text;
alter table public.asignaturas add column if not exists contenidos_minimos text;
alter table public.asignaturas add column if not exists formacion_practica text;
alter table public.asignaturas add column if not exists horas_formacion_practica text;

create table if not exists public.propuestas_plan (
  id bigint generated by default as identity primary key,
  docente_id bigint not null references public.docentes(id) on delete cascade,
  asignatura_id bigint references public.asignaturas(id) on delete set null,
  nombre_asignatura text,
  anio text,
  regimen text,
  horas_semanales text,
  horas_totales text,
  -- correlativas_regularizadas text,
  -- correlativas_aprobadas text,
  competencias_genericas text[],
  competencias_especificas text[],
  objetivos text,
  contenidos_minimos text,
  formacion_practica text,
  horas_formacion_practica text,
  comentarios text,
  created_at timestamptz not null default now()
);

create index if not exists propuestas_plan_docente_idx on public.propuestas_plan(docente_id);
create index if not exists propuestas_plan_asignatura_idx on public.propuestas_plan(asignatura_id);

create table if not exists public.propuestas_optativas (
  id bigint generated by default as identity primary key,
  docente_id bigint not null references public.docentes(id) on delete cascade,
  asignatura text,
  objetivos text,
  contenidos_minimos text,
  formacion_practica text,
  created_at timestamptz not null default now()
);

create index if not exists propuestas_optativas_docente_idx on public.propuestas_optativas(docente_id);

create table if not exists public.aportes_generales (
  id bigint generated by default as identity primary key,
  docente_id bigint not null references public.docentes(id) on delete cascade,
  tema text,
  detalle text,
  created_at timestamptz not null default now()
);

create index if not exists aportes_generales_docente_idx on public.aportes_generales(docente_id);

-- Relaciones de correlativas regularizadas
create table if not exists public.asignatura_correlativas_regularizadas (
  id bigint generated by default as identity primary key,
  asignatura_id bigint not null references public.asignaturas(id) on delete cascade,
  correlativa_id bigint not null references public.asignaturas(id) on delete cascade,
  created_at timestamptz not null default now(),
  unique(asignatura_id, correlativa_id)
);

create index if not exists acr_asignatura_idx on public.asignatura_correlativas_regularizadas(asignatura_id);
create index if not exists acr_correlativa_idx on public.asignatura_correlativas_regularizadas(correlativa_id);

create table if not exists public.propuestas_plan_correlativas_regularizadas (
  id bigint generated by default as identity primary key,
  propuesta_plan_id bigint not null references public.propuestas_plan(id) on delete cascade,
  correlativa_id bigint not null references public.asignaturas(id) on delete cascade,
  created_at timestamptz not null default now(),
  unique(propuesta_plan_id, correlativa_id)
);

create index if not exists ppcr_propuesta_idx on public.propuestas_plan_correlativas_regularizadas(propuesta_plan_id);
create index if not exists ppcr_correlativa_idx on public.propuestas_plan_correlativas_regularizadas(correlativa_id);

-- Relaciones de correlativas aprobadas
create table if not exists public.asignatura_correlativas_aprobadas (
  id bigint generated by default as identity primary key,
  asignatura_id bigint not null references public.asignaturas(id) on delete cascade,
  correlativa_id bigint not null references public.asignaturas(id) on delete cascade,
  created_at timestamptz not null default now(),
  unique(asignatura_id, correlativa_id)
);
create index if not exists aca_asignatura_idx on public.asignatura_correlativas_aprobadas(asignatura_id);
create index if not exists aca_correlativa_idx on public.asignatura_correlativas_aprobadas(correlativa_id);

create table if not exists public.propuestas_plan_correlativas_aprobadas (
  id bigint generated by default as identity primary key,
  propuesta_plan_id bigint not null references public.propuestas_plan(id) on delete cascade,
  correlativa_id bigint not null references public.asignaturas(id) on delete cascade,
  created_at timestamptz not null default now(),
  unique(propuesta_plan_id, correlativa_id)
);
create index if not exists ppca_propuesta_idx on public.propuestas_plan_correlativas_aprobadas(propuesta_plan_id);
create index if not exists ppca_correlativa_idx on public.propuestas_plan_correlativas_aprobadas(correlativa_id);

-- Limpieza: eliminar columnas de texto obsoletas (datos migrados a relaciones)
alter table public.asignaturas drop column if exists correlativas_regularizadas;
alter table public.asignaturas drop column if exists correlativas_aprobadas;
alter table public.propuestas_plan drop column if exists correlativas_regularizadas;
alter table public.propuestas_plan drop column if exists correlativas_aprobadas;

-- Row Level Security (RLS)
alter table public.docentes enable row level security;
alter table public.asignaturas enable row level security;
alter table public.propuestas_plan enable row level security;
alter table public.propuestas_optativas enable row level security;
alter table public.aportes_generales enable row level security;

-- Modo sin autenticación: políticas públicas
-- Permite a cualquiera (PUBLIC) leer e insertar sin requerir login

-- Asignaturas: lectura e inserción
drop policy if exists asignaturas_select_public on public.asignaturas;
create policy asignaturas_select_public
  on public.asignaturas for select to public
  using (true);

drop policy if exists asignaturas_insert_public on public.asignaturas;
create policy asignaturas_insert_public
  on public.asignaturas for insert to public
  with check (true);

-- Docentes: lectura e inserción
drop policy if exists docentes_select_public on public.docentes;
create policy docentes_select_public
  on public.docentes for select to public
  using (true);

drop policy if exists docentes_insert_public on public.docentes;
create policy docentes_insert_public
  on public.docentes for insert to public
  with check (true);

-- Propuestas plan: lectura e inserción
drop policy if exists propuestas_plan_select_public on public.propuestas_plan;
create policy propuestas_plan_select_public
  on public.propuestas_plan for select to public
  using (true);

drop policy if exists propuestas_plan_insert_public on public.propuestas_plan;
create policy propuestas_plan_insert_public
  on public.propuestas_plan for insert to public
  with check (true);

-- Propuestas optativas: lectura e inserción
drop policy if exists propuestas_optativas_select_public on public.propuestas_optativas;
create policy propuestas_optativas_select_public
  on public.propuestas_optativas for select to public
  using (true);

drop policy if exists propuestas_optativas_insert_public on public.propuestas_optativas;
create policy propuestas_optativas_insert_public
  on public.propuestas_optativas for insert to public
  with check (true);

-- Aportes generales: lectura e inserción
drop policy if exists aportes_generales_select_public on public.aportes_generales;
create policy aportes_generales_select_public
  on public.aportes_generales for select to public
  using (true);

drop policy if exists aportes_generales_insert_public on public.aportes_generales;
create policy aportes_generales_insert_public
  on public.aportes_generales for insert to public
  with check (true);

-- Nota: las inserciones a propuestas y docentes las hará el backend
-- con la SERVICE_ROLE_KEY, que bypass RLS. No se requieren políticas de insert para anon.

-- Datos iniciales de asignaturas (opcional)
insert into public.asignaturas (nombre) values
  ('Algoritmos y Estructuras de Datos'),
  ('Programación I'),
  ('Bases de Datos'),
  ('Sistemas Operativos')
on conflict (nombre) do nothing;

-- Alternativas de planes: lectura e inserción
drop policy if exists alternativas_planes_select_public on public.alternativas_planes;
create policy alternativas_planes_select_public
  on public.alternativas_planes for select to public
  using (true);

drop policy if exists alternativas_planes_insert_public on public.alternativas_planes;
create policy alternativas_planes_insert_public
  on public.alternativas_planes for insert to public
  with check (true);

drop policy if exists alternativas_planes_asignaturas_select_public on public.alternativas_planes_asignaturas;
create policy alternativas_planes_asignaturas_select_public
  on public.alternativas_planes_asignaturas for select to public
  using (true);

drop policy if exists alternativas_planes_asignaturas_insert_public on public.alternativas_planes_asignaturas;
create policy alternativas_planes_asignaturas_insert_public
  on public.alternativas_planes_asignaturas for insert to public
  with check (true);
```

## Conexión desde el proyecto

- Cliente del servidor: `lib/supabase.ts` crea `getSupabaseServer()` con `SUPABASE_SERVICE_ROLE_KEY` para uso en rutas API.
- Endpoints:
  - `GET /api/asignaturas` lista `id,nombre` ordenados.
  - `POST /api/asignaturas` inserta/actualiza por `nombre` (upsert).
  - `POST /api/submit` guarda docente y todas las propuestas (plan, optativas y aportes).

Con modo sin autenticación puedes también usar el cliente anónimo en el front (`getSupabaseAnon`) para leer/escribir directamente si lo prefieres.

## Prueba rápida

1. Coloca las variables en `.env.local` y reinicia el dev server.
2. Ejecuta el SQL en Supabase.
3. Abre `http://localhost:3000/`.
4. Verifica que el select de “Asignatura” cargue desde BD.
5. Completa algunas tarjetas y presiona “Enviar Todas las Propuestas”.
6. Revisa en Supabase las tablas para confirmar los registros.

## Notas

- Estas políticas abren lectura e inserción a cualquier visitante con el `anon key`. Úsalo solo si tu caso de uso no requiere control de acceso.
- Si luego decides añadir autenticación, cambia `to public` por `to authenticated` y ajusta las condiciones.
-- Asignatura_correlativas_regularizadas: lectura e inserción
drop policy if exists acr_select_public on public.asignatura_correlativas_regularizadas;
create policy acr_select_public
  on public.asignatura_correlativas_regularizadas for select to public
  using (true);

drop policy if exists acr_insert_public on public.asignatura_correlativas_regularizadas;
create policy acr_insert_public
  on public.asignatura_correlativas_regularizadas for insert to public
  with check (true);

-- Propuestas_plan_correlativas_regularizadas: lectura e inserción
drop policy if exists ppcr_select_public on public.propuestas_plan_correlativas_regularizadas;
create policy ppcr_select_public
  on public.propuestas_plan_correlativas_regularizadas for select to public
  using (true);

drop policy if exists ppcr_insert_public on public.propuestas_plan_correlativas_regularizadas;
create policy ppcr_insert_public
  on public.propuestas_plan_correlativas_regularizadas for insert to public
  with check (true);

-- Asignatura_correlativas_aprobadas: lectura e inserción
drop policy if exists aca_select_public on public.asignatura_correlativas_aprobadas;
create policy aca_select_public
  on public.asignatura_correlativas_aprobadas for select to public
  using (true);

drop policy if exists aca_insert_public on public.asignatura_correlativas_aprobadas;
create policy aca_insert_public
  on public.asignatura_correlativas_aprobadas for insert to public
  with check (true);

-- Propuestas_plan_correlativas_aprobadas: lectura e inserción
drop policy if exists ppca_select_public on public.propuestas_plan_correlativas_aprobadas;
create policy ppca_select_public
  on public.propuestas_plan_correlativas_aprobadas for select to public
  using (true);

drop policy if exists ppca_insert_public on public.propuestas_plan_correlativas_aprobadas;
create policy ppca_insert_public
  on public.propuestas_plan_correlativas_aprobadas for insert to public
  with check (true);